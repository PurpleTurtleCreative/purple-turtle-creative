(()=>{"use strict";const e=window.React,t=window.wp.element,n=(0,t.createContext)(!1);function a({children:a}){const[o,s]=(0,t.useState)(sessionStorage.getItem("ptcCustomer")||""),[i,r]=(0,t.useState)(""),[c,l]=(0,t.useState)(""),[u,m]=(0,t.useState)("idle");(0,t.useEffect)((()=>{sessionStorage.setItem("ptcCustomer",o)}),[o]);const d={status:"error",code:400,message:"Already processing another request.",data:null},p=async(e,t={})=>"loading"!==u?(m("loading"),await window.fetch(`${window.ptcTheme.api.v1}/customer/authenticate`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.ptcTheme.api.auth_nonce},body:JSON.stringify({action:e,email:w.emailInput,password:w.passwordInput,nonce:window.ptcTheme.api.nonce,...t})}).then((async e=>{const t=await e.json();return e.ok&&t?.data?.authToken&&s(t.data.authToken),t})).catch((e=>({status:"error",code:500,message:e,data:null}))).finally((()=>{m("idle")}))):d,w={processingStatus:u,emailInput:i,setEmailInput:r,passwordInput:c,setPasswordInput:l,isLoggedIn:()=>!!o,login:async(e={})=>await p("login",e),signup:async(e={})=>await p("signup",e),logout:()=>{s("")},verifyEmail:async()=>"loading"!==u?(m("loading"),await window.fetch(`${window.ptcTheme.api.v1}/mailing-lists/subscribe`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.ptcTheme.api.auth_nonce},body:JSON.stringify({email:w.emailInput,list_id:"a2tBf2KrKnxBF66s",nonce:window.ptcTheme.api.nonce})}).then((async e=>{if(!e.ok)throw`Failed to verify email. Error: ${e.statusText}`;return await e.json()})).catch((e=>({status:"error",code:500,message:e,data:null}))).finally((()=>{m("idle")}))):d,resetPassword:async()=>await window.fetch().then((e=>e.json())).then((e=>e.data)).catch((e=>null)),fetchCustomerData:async()=>await window.fetch().then((e=>e.json())).then((e=>e.data)).catch((e=>null)),goToCheckout:(e,t)=>{},goToBillingPortal:()=>{}};return(0,e.createElement)(n.Provider,{value:w},a)}function o(){const{emailInput:a,setEmailInput:o}=(0,t.useContext)(n);return(0,e.createElement)("div",{className:"ptc-FormInputCustomerEmail"},(0,e.createElement)("label",{htmlFor:"customer-email"},"Email"),(0,e.createElement)("input",{type:"email",id:"customer-email",name:"email",value:a,onChange:e=>{o(e.target.value)},required:!0}))}function s({extraClassNames:a=""}){const{passwordInput:o,setPasswordInput:s}=(0,t.useContext)(n);return(0,e.createElement)("div",{className:"ptc-FormInputCustomerPassword"+a},(0,e.createElement)("label",{htmlFor:"customer-password"},"Password"),(0,e.createElement)("input",{type:"password",id:"customer-password",name:"password",value:o,onChange:e=>{s(e.target.value)},required:!0}))}function i({action:t}){let n=null;return window?.ptcTheme?.cf_turnstile?.site_key?t?n=(0,e.createElement)(e.Fragment,null,(0,e.createElement)("input",{type:"hidden",name:"cf-turnstile-action",value:t}),(0,e.createElement)("div",{class:"cf-turnstile","data-language":"en-us","data-theme":"light","data-size":"normal","data-appearance":"always","data-sitekey":window.ptcTheme.cf_turnstile.site_key,"data-action":t})):window.console.error("Failed to render FormInputCaptcha without specified action."):window.console.error("Failed to render FormInputCaptcha without configured Cloudflare Turnstile site key."),(0,e.createElement)("div",{className:"ptc-FormInputCaptcha"},n)}function r({slots:n,onChange:a}){const o=Array.from({length:n.length},(()=>(0,t.useRef)()));return(0,e.createElement)("div",{className:"ptc-FormInputCodePuncher"},(0,e.createElement)("fieldset",null,(0,e.createElement)("legend",null,"Verification Code"),(0,e.createElement)("div",{className:"code-puncher"},n.map(((t,s)=>(0,e.createElement)("input",{key:s,ref:o[s],name:`code_punch_digits[${s}]`,type:"text",inputMode:"numeric",maxLength:"1",value:t,onChange:e=>((e,t)=>{if(1===t.length&&/^\d$/.test(t)){const s=[...n];s[e]=t,a(s),e<n.length-1&&o[e+1].current.focus()}})(s,e.target.value),onKeyDown:e=>((e,t)=>{if("Backspace"===t.key&&e>0){const t=[...n];let s=e-1;o[e].current.value&&(s=e),t[s]="",a(t),o[s].current.focus()}})(s,e),"aria-label":`Digit ${s+1}`}))))))}function c({email:n,list_id:a,onSuccess:o}){const[s,i]=(0,t.useState)(Array.from({length:6},(()=>""))),[c,l]=(0,t.useState)("idle"),[u,m]=(0,t.useState)(""),d=(0,t.useRef)();(0,t.useEffect)((async()=>{"loading"!==c&&(l("loading"),await window.fetch(`${window.ptcTheme.api.v1}/mailing-lists/subscribe`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.ptcTheme.api.auth_nonce},body:JSON.stringify({email:n,list_id:a,verification_type:"code"})}).then((async e=>{const t=await e.json();e.ok&&"success"===t?.status?o(t):m(t?.message?t.message:"Failed to verify email. Please try again.")})).catch((e=>{window.console.error(e),m(e.message)})).finally((()=>{l("idle")})))}),[]),(0,t.useEffect)((()=>{6===s.join("").length&&d.current.requestSubmit()}),[s]);let p=null;return p="loading"===c?(0,e.createElement)("p",null,"Loading..."):(0,e.createElement)("form",{ref:d,onSubmit:async e=>{e.preventDefault();const t=s.join("");if(6!==t.length)return m("Please enter the 6-digit verification code."),!1;"loading"!==c&&(l("loading"),await window.fetch(`${window.ptcTheme.api.v1}/mailing-lists/verify`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":window.ptcTheme.api.auth_nonce},body:JSON.stringify({email:n,list_id:a,verification_code:t})}).then((async e=>{const t=await e.json();e.ok&&"success"===t?.status?o(t):m(t?.message?t.message:"Failed to verify email. Please try again.")})).catch((e=>{window.console.error(e),m(e.message)})).finally((()=>{l("idle")})))}},(0,e.createElement)("p",null,"Confirm your email address"),(0,e.createElement)("p",null,`To continue, please enter the 6-digit verification code sent to your ${n} email.`),(0,e.createElement)(r,{slots:s,onChange:i}),(0,e.createElement)("button",{type:"submit"},"Continue")),(0,e.createElement)("div",{className:"ptc-FormStepVerificationCode"},u&&(0,e.createElement)("p",null,u),p)}function l(a){const{emailInput:r,isLoggedIn:l,passwordInput:u,processingStatus:m,signup:d}=(0,t.useContext)(n),[p,w]=(0,t.useState)(""),[h,g]=(0,t.useState)(""),f=async e=>{if(e.preventDefault(),h!==u)return void w("password_mismatch");w("");const t=new FormData(e.target);d({"cf-turnstile-action":t.get("cf-turnstile-action"),"cf-turnstile-response":t.get("cf-turnstile-response")}).then((e=>{"success"===e?.status?(a(e),w("")):w(403===e?.code?"unverified_email":e?.message?e.message:"Failed to create new account. Please try again.")}))};let y=p;"password_mismatch"===p?y="Passwords do not match. Please ensure your password was entered correctly into both fields and try again.":"unverified_email"===p&&(y="");let E=null;if(l())E=(0,e.createElement)("p",null,"You are already logged in.");else if("loading"===m)E=(0,e.createElement)("p",null,"Loading...");else if("unverified_email"===p)E=(0,e.createElement)(c,{email:r,list_id:window.ptcTheme.billing.customers_list_id,onSuccess:e=>{window.console.trace(e),w("")}});else{let t="";"password_mismatch"===p&&(t+=" input-error"),E=(0,e.createElement)("form",{onSubmit:f},(0,e.createElement)(o,null),(0,e.createElement)(s,{extraClassNames:t}),(0,e.createElement)("div",{className:"customer-confirm-password"+t},(0,e.createElement)("label",{htmlFor:"customer-confirm-password"},"Confirm Password"),(0,e.createElement)("input",{type:"password",id:"customer-confirm-password",name:"confirm_password",value:h,onChange:e=>{g(e.target.value)},required:!0})),(0,e.createElement)(i,{action:"ptc-customer-create-account"}),(0,e.createElement)("button",{type:"submit"},"Create Account"),(0,e.createElement)("p",null,(0,e.createElement)("small",null,"By submitting this form, you agree to our ",(0,e.createElement)("a",{href:"https://purpleturtlecreative.com/privacy-policy/"},"Privacy Policy")," and to receiving important email messages from Purple Turtle Creative about your purchases. A verification email will be sent to confirm your account creation.")))}return(0,e.createElement)("div",{className:"ptc-FormCustomerCreateAccount"},y&&(0,e.createElement)("p",null,y),E)}function u({onSuccess:n}){const[a,o]=(0,t.useState)("idle");return(0,e.createElement)("div",{className:"ptc-FormCustomerAuthentication"},(0,e.createElement)("h2",null,"Create or Log In to Your Account"),(0,e.createElement)("p",null,"Please create an account or sign in to manage your software licenses and billing information."),(0,e.createElement)(l,null))}document.addEventListener("DOMContentLoaded",(()=>{const n=document.querySelector("#ptc-react-customer-authentication");if(n){const o=e=>{window.console.log("Successfully authenticated!",e)};(0,t.createRoot)(n).render((0,e.createElement)(a,null,(0,e.createElement)(u,{onSuccess:o})))}}))})();